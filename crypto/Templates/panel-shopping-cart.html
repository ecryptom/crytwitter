{% extends 'base.html' %} {% load static %} {% block header %}
<title>ارز توییتر</title>
<link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}" />
<link rel="stylesheet" href="{% static 'css/pushy.min.css' %}" />
<link rel="stylesheet" href="{% static 'css/main.min.css' %}" />
<link rel="stylesheet" href="{% static 'css/panel.min.css' %}" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /> {% endblock header %} {% block page %}

<div class="page-wrapper">
    <section class="panel">
        <div class="container panel-container">
            <div class="row panel-row">
                <div class="col-12 col-sm-12 col-md-4 col-lg-3 col-xl-3 panel-right-col">
                    <div class="panel-right">
                        <div class="panel-right-profile">
                            <img src="{{user.image.url}}" class="panel-right-profile-image" alt="{{user.name}}" />
                            <h2 class="panel-right-profile-heading-two">
                                {{user.name}}
                            </h2>
                        </div>
                        <ul class="panel-right-list">
                            <li class="panel-right-item panel-right-item-active">
                                <a href="{% url 'dashboard' %}" class="panel-right-link">
                                    <i class="fa fa-dashboard panel-right-icon"></i> داشبورد
                                </a>
                            </li>
                            <li class="panel-right-item">
                                <a href="{% url 'edit_profile' %}" class="panel-right-link">
                                    <i class="fa fa-edit panel-right-icon"></i> ویرایش اطلاعات شخصی
                                </a>
                            </li>
                            <li class="panel-right-item">
                                <a href="{% url 'change_pass' %}" class="panel-right-link">
                                    <i class="fa fa-lock panel-right-icon"></i> تغییر کلمه عبور
                                </a>
                            </li>
                            <li class="panel-right-item">
                                <a href="{% url 'cart' %}" class="panel-right-link">
                                    <i class="fa fa-shopping-cart panel-right-icon"></i> سبد خريد
                                </a>
                            </li>
                            <li class="panel-right-item">
                                <a href="{% url 'invite_friends' %}" class="panel-right-link">
                                    <i class="fa fa-users panel-right-icon"></i> دعوت از دوستان
                                </a>
                            </li>
                            <li class="panel-right-item">
                                <a href="{% url 'logout' %}" class="panel-right-link">
                                    <i class="fa fa-sign-out panel-right-icon"></i> خروج از حساب کاربری
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="col-12 col-sm-12 col-md-8 col-lg-9 col-xl-9 panel-left-col">
                    <div class="panel-left">

                    <!--current cart-->
                        <div class="panel-left-shopping-cart" id="carts">
                            <div class="panel-left-shopping-cart-header">
                                <h3 class="panel-left-shopping-cart-header-heading-three">
                                    سبد خرید
                                </h3>
                            </div>

                    {% if message %}
                        <div class="alert alert-info w-75 mx-auto">
                            <p style="text-align: center">{{message}}</p>
                        </div>
                    {% endif %}

                            <div class="panel-left-shopping-cart-content">
                                {% if cart %}
                                <div id="cart_table">
                                <table class="panel-left-shopping-cart-content-table table table-bordered table-hover table-striped table-light" id="shoppingTable">
                                    <thead class="panel-left-shopping-cart-content-table-header thead-dark">
                                        <tr class="panel-left-shopping-cart-content-table-row">
                                            <th class="panel-left-shopping-cart-content-table-heading">
                                                شماره
                                            </th>
                                            <th class="panel-left-shopping-cart-content-table-heading">
                                                محصول
                                            </th>
                                            <th class="panel-left-shopping-cart-content-table-heading">
                                                قيمت
                                            </th>
                                            <th class="panel-left-shopping-cart-content-table-heading">
                                                تعداد
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="cart_tbody" class="panel-left-shopping-cart-content-table-content">
                                        {% for order in cart.order_set.all %}
                                            <tr id="order{{order.product.id}}" class="panel-left-shopping-cart-content-table-row">
                                                <td data-label="شماره" class="panel-left-shopping-cart-content-table-data">
                                                    {{ forloop.counter }}
                                                </td>
                                                <td data-label="محصول" class="panel-left-shopping-cart-content-table-data">
                                                    <a href="{% url 'product' order.product.id %}">
                                                        <img src="{{order.product.image1.url}}" class="" /> {{order.product.name}}
                                                    </a>
                                                </td>
                                                {% if order.product.is_available %}
                                                    <td data-label="قيمت" class="panel-left-shopping-cart-content-table-data withcommas">
                                                        {{order.product.net_price}}
                                                    </td>
                                                {% else %}
                                                    <td data-label="قيمت" class="panel-left-shopping-cart-content-table-data">
                                                        <span style="color:red">ناموجود</span>
                                                    </td>
                                                {% endif %}
                                                <td data-label="تعداد" class="panel-left-shopping-cart-content-table-data">
                                                    {% if order.product.is_available %}
                                                        <a onclick="removeFromCart({{order.product.id}})" class="panel-left-shopping-cart-content-table-link">
                                                            <i class="fa fa-minus shopping-cart-table-icon"></i>
                                                        </a>
                                                        <span id="number{{order.product.id}}" class="panel-left-shopping-cart-content-table-count">{{order.number}}</span>
                                                        <a onclick="addToCart({{order.product.id}})" class="panel-left-shopping-cart-content-table-link">
                                                            <i class="fa fa-plus panel-left-shopping-cart-content-table-icon"></i>
                                                        </a>
                                                    {% else %}
                                                        <a onclick="remove_order({{order.id}}, {{order.product.id}})">
                                                            <span style="color:ted">حذف</span>
                                                        </a>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                <div class="sum" >
                                        جمع کل : <span id="cost" class="withcommas">{{cart.cost}}</span> تومان
                                    </div>
                                <a href="{% url 'payment_request' cart.id %}" class="panel-left-shopping-cart-content-link">تأیید و پرداخت</a>
                                </div>
                                
                                <div id="epmty_cart" hidden>
                                        <div class="panel-left-shopping-cart-content-alert">  سبد خرید شما خالی است! </div>
                                        <img src="{% static 'img/shopping-cart.png' %}" style="height: 230px;display: block;margin: 10px auto;width: 80%;" />
                                    </div>
                                {% else %}
                                    <div id="epmty_cart">
                                        <div class="panel-left-shopping-cart-content-alert">  سبد خرید شما خالی است! </div>
                                        <img src="{% static 'img/shopping-cart.png' %}" style="height: 230px;display: block;margin: 10px auto;width: 80%;" />
                                    </div>
                                {% endif %}

                            </div>
                        </div>
                    <!--end current cart-->

                    <!--paid carts-->
                    <hr>
                    {% if paid_carts %}
                        <div class="panel-left-shopping-cart">
                            <div class="panel-left-shopping-cart-header">
                                <h3 class="panel-left-shopping-cart-header-heading-three">
                                    خرید های قبلی
                                </h3>
                            </div>
                            {% for paid_cart in paid_carts %}
                            <div class="panel-left-shopping-cart-content">
                                    <table class="panel-left-shopping-cart-content-table table table-bordered table-hover table-striped table-light" id="shoppingTable">
                                        <thead class="panel-left-shopping-cart-content-table-header thead-dark">
                                            <tr class="panel-left-shopping-cart-content-table-row">
                                                <th class="panel-left-shopping-cart-content-table-heading">
                                                    شماره
                                                </th>
                                                <th class="panel-left-shopping-cart-content-table-heading">
                                                    محصول
                                                </th>
                                                <th class="panel-left-shopping-cart-content-table-heading">
                                                    قيمت
                                                </th>
                                                <th class="panel-left-shopping-cart-content-table-heading">
                                                    تعداد
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody class="panel-left-shopping-cart-content-table-content">
                                        {% for order in paid_cart.order_set.all %}
                                            <tr id="order{{order.product.id}}" class="panel-left-shopping-cart-content-table-row">
                                                <td class="panel-left-shopping-cart-content-table-data">
                                                    {{ forloop.counter }}
                                                </td>
                                                <td class="panel-left-shopping-cart-content-table-data">
                                                    <a href="{% url 'product' order.product.id %}">
                                                        <img src="{{order.product.image1.url}}" class="" /> {{order.product.name}}
                                                    </a>
                                                </td>
                                                <td class="panel-left-shopping-cart-content-table-data">
                                                    {{order.product.net_price}}
                                                </td>
                                                <td class="panel-left-shopping-cart-content-table-data">
                                                    <span id="number{{order.product.id}}" class="panel-left-shopping-cart-content-table-count">{{order.number}}</span>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                        <tfoot class="panel-left-shopping-cart-content-table-footer">
                                            <tr class="panel-left-shopping-cart-content-table-row table-info">
                                                <td class="panel-left-shopping-cart-content-table-data">
                                                    جمع كل:
                                                </td>
                                                <td class="panel-left-shopping-cart-content-table-data">
                                                </td>
                                                <td onch id="cost" class="panel-left-shopping-cart-content-table-data">
                                                    {{paid_cart.cost}}
                                                </td>
                                                <td class="panel-left-shopping-cart-content-table-data">
                                                    -
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>

                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <!--end paid carts-->
                    </div>
                </div>
            </div>
    </section>

    </div>
    {% endblock page %} 
{% block scripts %}

<!---------------------split number with camma---------------------->
<script>
    function numberWithCommas(x) {
        var parts = x.toString().split(".");
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join(".");
    }
    prices = document.getElementsByClassName('withcommas');
    for(var i=0; i< prices.length; i++){
        prices[i].innerText = numberWithCommas(parseInt(prices[i].innerText));
    }

</script>



<!---------------------add or remove product---------------------->
<script>

        function addToCart(ID) {
            $.ajax({
                url: '/product/add_product/' + ID,
                dataType: "json",
                success: function(result, s, x) {
                    if (result.number == 0)
                        document.getElementById("order" + ID).remove();
                    else
                        document.getElementById("number" + ID).innerHTML = result.number;
                    document.getElementById("cost").innerHTML = numberWithCommas(parseInt(result.cost));
                }
            })
        }

        function removeFromCart(ID) {
            $.ajax({
                url: '/product/remove_product/' + ID,
                dataType: "json",
                success: function(result, s, x) {
                    if (result.number == 0){
                        document.getElementById("order" + ID).remove();
                        if(document.getElementById("cart_tbody").childElementCount == 0){
                            document.getElementById("cart_table").remove();
                            document.getElementById("epmty_cart").hidden = false;
                        }
                        }

                    else
                        document.getElementById("number" + ID).innerHTML = result.number;
                    document.getElementById("cost").innerHTML = numberWithCommas(parseInt(result.cost));
                }
            })
        }

    function remove_order(order_id, product_id){
        $.ajax({
                url: '/product/remove_order/' + order_id,
                dataType: "json",
                success: function(result, s, x) {
                    document.getElementById("order"+product_id).remove();
                    if(document.getElementById("cart_tbody").childElementCount == 0){
                        document.getElementById("cart_table").remove();
                        document.getElementById("epmty_cart").hidden = false;
                    }
                }
            })
    }
</script>
    {% endblock scripts %}